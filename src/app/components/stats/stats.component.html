<mat-card class="stats-card">
  <div fxLayout="column" fxFill>
    <div fxFlex="0 0 auto" fxLayout="row">
      <p>Current client IPv4: {{ ip }}</p>
      <span fxFlex></span>
      <span>
        <mat-slide-toggle
          class=""
          [color]="'primary'"
          [checked]="checkedCities"
          (toggleChange)="checkedCities = !checkedCities"
        >
          IP/Cities
        </mat-slide-toggle>
      </span>
    </div>
    <br />

    <div fxFlex fxLayout="column" *ngIf="checkedCities === false">
      <div fxFlex="0 0 auto" fxLayout="row">
        <span fxFlex>IP</span>
        <span fxFlex>Date</span>
        <span fxFlex>Time</span>
        <span fxFlex>City</span>
      </div>
      <hr />
      <div
        fxFlex
        fxLayout="column"
        class="scroll-this"
        [@showStats]="citiesLength"
      >
        <!-- <div
          *ngFor="let logEntryIp of historyLog | keyvalue; let odd = odd"
          fxLayout="row"
          fxLayoutAlign="start center"
          [class.odd]="odd"
        >
          <span fxFlex>{{ logEntryIp.key | replace: '-':'.' }}</span>
          <span fxFlex>{{ (logEntryIp.value | keyvalue)[0].key | date: 'dd/MM/yyyy' }}</span>
          <span fxFlex>{{ (logEntryIp.value | keyvalue)[0].key | date: 'HH:mm' }}</span>
          <span fxFlex>{{ cities[(logEntryIp.value | keyvalue)[0].value].name }}</span>

        </div> -->
        <ng-container
        *ngFor="let logEntryIp of historyLog | keyvalue; let odd=odd"
        >
          <div
            fxLayout="row"
            fxLayoutAlign="start center"
            [class.odd]="odd"
            (click)="showDetails[logEntryIp.key] = !showDetails[logEntryIp.key]"
          >
            <span fxFlex>{{ logEntryIp.key | replace: '-':'.' }}</span>
            <span fxFlex>{{ (logEntryIp.value | keyvalue | sortKeys:-1)[0].key | date: 'dd/MM/yyyy' }}</span>
            <span fxFlex>{{ (logEntryIp.value | keyvalue | sortKeys:-1)[0].key | date: 'HH:mm' }}</span>
            <span fxFlex>{{ cities[(logEntryIp.value | keyvalue)[0].value].name }}</span>
          </div>

          <ng-container *ngIf="showDetails[logEntryIp.key]">
            <ng-container
              *ngFor="let logEntryTime of logEntryIp.value | keyvalue | sortKeys:-1; let oddsub=odd"
              >
              <div
                fxLayout="row"
                fxLayoutAlign="start center"
                [class.odd]="odd !== oddsub"
                (click)="showDetails[logEntryIp.key] = !showDetails[logEntryIp.key]"
              >
                <span fxFlex></span>
                <span fxFlex>{{ logEntryTime.key | date: 'dd/MM/yyyy' }}</span>
                <span fxFlex>{{ logEntryTime.key | date: 'HH:mm:ss' }}</span>
                <span fxFlex>{{ cities[logEntryTime.value].name }}</span>
              </div>
            </ng-container>
          </ng-container>
        </ng-container>
      </div>
    </div>

    <div fxFlex fxLayout="column" *ngIf="checkedCities">
      <div fxFlex="0 0 auto" fxLayout="row">
        <span fxFlex></span>
        <span fxFlex>All clients</span>
        <span fxFlex>Requests</span>
        <span fxFlex>Updates</span>
      </div>
      <hr />
      <div fxFlex="0 0 auto" fxLayout="row">
        <span fxFlex>Owm</span>
        <span fxFlex></span>
        <span fxFlex>{{ stats.r }}</span>
        <span fxFlex>{{ stats.u }}</span>
      </div>
      <hr />
      <div
        fxLayout="column"
        class="scroll-this"
        [@showStats]="citiesLength"
      >
        <div
          *ngFor="let city of cities | keyvalue; let odd = odd"
          fxFlex
          fxLayout="row"
          fxLayoutAlign="start center"
          [class.odd]="odd"
        >
          <span fxFlex class="truncate">{{ city.value.name }}</span>
          <span fxFlex class="truncate">{{ city.value.country }}</span>
          <span fxFlex>{{ stats[city.key]?.reads || city.value.r }}</span>
          <span fxFlex>{{ stats[city.key]?.updates || city.value.u }}</span>
        </div>
      </div>
    </div>
  </div>
</mat-card>
